<!DOCTYPE html>
<html>
	<head>
		<style>
			@import url('https://fonts.googleapis.com/css2?family=Rubik:ital,wght@0,300;0,400;0,500;0,600;0,700;0,800;0,900;1,300;1,400;1,500;1,600;1,700;1,800;1,900&display=swap');
		</style>
		<style>
			body {
				margin: 0;
				padding: 0;
			}
				
			* {
				margin: 0;
				font-family: 'Rubik', sans-serif;
			}
	
			#app {
				width: 100vw;
				height: 100vh;
				background: linear-gradient(rgb(220, 62, 147), rgb(28, 75, 179));
				display: flex;
				align-items: center;
				justify-content: center;
			}
			
			#login-box {
				background: white;
				width: 85%;
				max-width: 400px;
				height: 600px;
				max-height: 75%;
				border-radius: 3px;
				display: flex;
				flex-direction: column;
				align-items: center;
				justify-content: space-between;
			}
			
			#login {
				display: flex;
				align-items: center;
				justify-content: center;
				flex-direction: column;
				gap: 10px;
				width: 100%;
			}
	
			#messages {
				display: flex;
				flex-direction: column;
				gap: 20px;
				opacity: 1;
			}
			
			.main {
			}
			
			.info {
				display: flex;
				align-items: center;
				justify-content: flex-start;
				gap: 5px
			}
			
			.infotext {
				font-size: 10px;
			}
			
			.message {
				font-size: 15px;

			}
			
			#sendbox {
				marginTop: 20px;
				display: none;
			}
			
			.input-box {
				display: flex;
				width: 75%;
				background: rgb(230, 230, 230);
				padding: 20px 15px;
				border-radius: 1px;
				gap: 10px;
			}
			
			.input {
				padding: 0;
				width: 100%;
				background: none;
				border: none;
				font-size: 18px;
			}
			
			.input:focus {
				outline: none;
			}
			
			#title {
				margin-top: 50px;
				margin-bottom: 25px;
			}
			
			.input-img {
				width: 25px;
				height: 25px;
			}
			
			#button {
				width: 75%;
				border-radius: 1px;
				background: rgb(220, 62, 147);
				padding: 20px 15px;
				display: flex;
				align-items: center;
				justify-content: center;
				margin-top: 10px;
			}
			
			#enter-text {
				margin: 0;
				color: white;
				font-weight: 800;
			}
			
			#req-text {
				margin: 30px;
				color: rgb(140, 140, 140);
				font-size: 14px;
			}
			
			.underline {
				text-decoration: underline;
				user-select: none;	
			}
		</style>
		<script>
			const dev = "http://localhost:3000/"
			const prod = "https://banananananan.onrender.com/"
			const backend = prod
			
			let un = null
			let pw = null
			
			function httpGet(theUrl) {
			    var xmlHttp = new XMLHttpRequest();
			    xmlHttp.open( "GET", theUrl, "false" ); // false for synchronous request
			    xmlHttp.send( null );
			    return xmlHttp;
			}
			
			function timeDifference(current, previous) {
			    var msPerMinute = 60 * 1000;
			    var msPerHour = msPerMinute * 60;
			    var msPerDay = msPerHour * 24;
			    var msPerMonth = msPerDay * 30;
			    var msPerYear = msPerDay * 365;
			    var elapsed = current - previous;
			    if (elapsed < msPerMinute) {
				 return Math.round(elapsed/1000) + 's ago';   
			    }
			    else if (elapsed < msPerHour) {
				 return Math.round(elapsed/msPerMinute) + 'm ago';   
			    }
			    else if (elapsed < msPerDay ) {
				 return Math.round(elapsed/msPerHour ) + 'h ago';   
			    }
			    else if (elapsed < msPerMonth) {
				return Math.round(elapsed/msPerDay) + 'd ago';   
			    }
			    else if (elapsed < msPerYear) {
				return Math.round(elapsed/msPerMonth) + 'mo ago';   
			    }
			    else {
				return Math.round(elapsed/msPerYear ) + 'y ago';   
			    }
			}
			
			window.onload = () => {
				document.getElementById("button").addEventListener("click", (e) => {
					const username = document.getElementById("username").value
					const password = document.getElementById("password").value
					fetch(backend + "login", {
						method: "PUT",
				        	headers: {
						 	'Content-type': 'application/json; charset=UTF-8',
							'username': username,
							'password': password,
						},
					})
					  .then(
					    response => response.text()
					  ).then(
					    text => {
					    	if (text === "success") {
					    		un = username
					    		pw = password
    							fetch(backend + "fetch", {
								method: "PUT",
								headers: {
								 	'Content-type': 'application/json; charset=UTF-8',
									'username': username,
									'password': password,
								},
							})
							  .then(
							    response => response.json()
							  ).then(
							    data => {
						    		document.getElementById("login").style.display = "none"
						    		document.getElementById("sendbox").style.display = "block"
						    		for (var x of data) {
						    			const main = document.createElement("div")
						    			const t = document.createElement("p") 
						    			const time = document.createTextNode(timeDifference(Date.now(), x.time))
						    			const m = document.createElement("p") 
						    			const message = document.createTextNode(x.message)
						    			const u = document.createElement("p") 
						    			const username = document.createTextNode(x.username)
						    			const info = document.createElement("div")									
						    			t.appendChild(time)
						    			t.classList.add("infotext")
						    			m.appendChild(message)
						    			m.classList.add("message")
						    			u.appendChild(username)
						    			u.classList.add("infotext")
						    			info.appendChild(u)
						    			info.appendChild(t)
						    			info.classList.add("info")
						    			main.appendChild(m)
						    			main.appendChild(info)
						    			main.classList.add("main")
						    			document.getElementById("messages").appendChild(main)
						    		}
						    		
						    		setInterval(() => {
    		    							fetch(backend + "fetch", {
										method: "PUT",
										headers: {
										 	'Content-type': 'application/json; charset=UTF-8',
											'username': username,
											'password': password,
										},
									})
									  .then(
									    response => response.json()
									  ).then(
									    data => {
		    							  	document.getElementById("messages").innerHTML = ""
								    		for (var x of data) {
								    			const main = document.createElement("div")
								    			const t = document.createElement("p") 
								    			const time = document.createTextNode(timeDifference(Date.now(), x.time))
								    			const m = document.createElement("p") 
								    			const message = document.createTextNode(x.message)
								    			const u = document.createElement("p") 
								    			const username = document.createTextNode(x.username)
								    			const info = document.createElement("div")									
								    			t.appendChild(time)
								    			t.classList.add("infotext")
								    			m.appendChild(message)
								    			m.classList.add("message")
								    			u.appendChild(username)
								    			u.classList.add("infotext")
								    			info.appendChild(u)
								    			info.appendChild(t)
								    			info.classList.add("info")
								    			main.appendChild(m)
								    			main.appendChild(info)
								    			main.classList.add("main")
								    			document.getElementById("messages").appendChild(main)
								    		}
								    	})
						    		}, 10000)
							    }
							  );
					    	} else alert(text)
					    }
					  );
				})
				document.getElementById("sendbutton").addEventListener("click", (e) => {
					const message = document.getElementById("send").value 
					fetch(backend + "new", {
						method: "POST",
				        	headers: {
						 	'Content-type': 'application/json; charset=UTF-8',
							'username': un,
							'password': pw,
							'message': message,
						},
					})
					  .then(
					    response => response.json()
					  ).then(data => {
					  	document.getElementById("messages").innerHTML = ""
				    		for (var x of data) {
				    			const main = document.createElement("div")
				    			const t = document.createElement("p") 
				    			const time = document.createTextNode(timeDifference(Date.now(), x.time))
				    			const m = document.createElement("p") 
				    			const message = document.createTextNode(x.message)
				    			const u = document.createElement("p") 
				    			const username = document.createTextNode(x.username)
				    			const info = document.createElement("div")									
				    			t.appendChild(time)
				    			t.classList.add("infotext")
				    			m.appendChild(message)
				    			m.classList.add("message")
				    			u.appendChild(username)
				    			u.classList.add("infotext")
				    			info.appendChild(u)
				    			info.appendChild(t)
				    			info.classList.add("info")
				    			main.appendChild(m)
				    			main.appendChild(info)
				    			main.classList.add("main")
				    			document.getElementById("messages").appendChild(main)
				    		}
					  })
				})
			}
		</script>
	</head>
	<body>
		<div id="app">
			<div id="login-box">
				<div id="login">
					<h1 id="title"">LOGIN</h1>
					<div class="input-box">
						<img src="user.png" class="input-img"></img>
						<input id="username" placeholder="Username" class="input"></input>
					</div>
					<div class="input-box">
						<img src="lock.png" class="input-img"></img>
						<input type="password" id="password" placeholder="Password" class="input"></input>
					</div>
					<div id="button"><p id="enter-text"s>LOGIN</p></div>
				</div>
				<p id="req-text">Not a member? <span class="underline">Request account</span></p>
			</div>
			<div id="messages"></div>
			<div id="sendbox">
				<input id="send"></input><button id="sendbutton">send</button>
			</div>
		</div>
	</body>
</html>
